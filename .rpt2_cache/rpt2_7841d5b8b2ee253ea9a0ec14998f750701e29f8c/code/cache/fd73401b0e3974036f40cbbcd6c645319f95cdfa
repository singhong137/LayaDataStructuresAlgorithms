{
  "code": "import { Event } from \"../../events/Event\";\r\nimport { SoundChannel } from \"../SoundChannel\";\r\nimport { Browser } from \"../../utils/Browser\";\r\nimport { Utils } from \"../../utils/Utils\";\r\nimport { ILaya } from \"../../../ILaya\";\r\nexport class WebAudioSoundChannel extends SoundChannel {\r\n    constructor() {\r\n        super();\r\n        this.bufferSource = null;\r\n        this._currentTime = 0;\r\n        this._volume = 1;\r\n        this._startTime = 0;\r\n        this._pauseTime = 0;\r\n        this.context = ILaya.WebAudioSound.ctx;\r\n        this._onPlayEnd = Utils.bind(this.__onPlayEnd, this);\r\n        if (this.context[\"createGain\"]) {\r\n            this.gain = this.context[\"createGain\"]();\r\n        }\r\n        else {\r\n            this.gain = this.context[\"createGainNode\"]();\r\n        }\r\n    }\r\n    play() {\r\n        ILaya.SoundManager.addChannel(this);\r\n        this.isStopped = false;\r\n        this._clearBufferSource();\r\n        if (!this.audioBuffer)\r\n            return;\r\n        if (this.startTime >= this.duration)\r\n            return stop();\r\n        var context = this.context;\r\n        var gain = this.gain;\r\n        var bufferSource = context.createBufferSource();\r\n        this.bufferSource = bufferSource;\r\n        bufferSource.buffer = this.audioBuffer;\r\n        bufferSource.connect(gain);\r\n        if (gain)\r\n            gain.disconnect();\r\n        gain.connect(context.destination);\r\n        bufferSource.onended = this._onPlayEnd;\r\n        this._startTime = Browser.now();\r\n        if (this.gain.gain.setTargetAtTime) {\r\n            this.gain.gain.setTargetAtTime(this._volume, this.context.currentTime, WebAudioSoundChannel.SetTargetDelay);\r\n        }\r\n        else\r\n            this.gain.gain.value = this._volume;\r\n        if (this.loops == 0) {\r\n            bufferSource.loop = true;\r\n        }\r\n        if (bufferSource.playbackRate.setTargetAtTime) {\r\n            bufferSource.playbackRate.setTargetAtTime(ILaya.SoundManager.playbackRate, this.context.currentTime, WebAudioSoundChannel.SetTargetDelay);\r\n        }\r\n        else\r\n            bufferSource.playbackRate.value = ILaya.SoundManager.playbackRate;\r\n        bufferSource.start(0, this.startTime);\r\n        this._currentTime = 0;\r\n    }\r\n    __onPlayEnd() {\r\n        if (this.loops == 1) {\r\n            if (this.completeHandler) {\r\n                ILaya.timer.once(10, this, this.__runComplete, [this.completeHandler], false);\r\n                this.completeHandler = null;\r\n            }\r\n            this.stop();\r\n            this.event(Event.COMPLETE);\r\n            return;\r\n        }\r\n        if (this.loops > 0) {\r\n            this.loops--;\r\n        }\r\n        this.startTime = 0;\r\n        this.play();\r\n    }\r\n    get position() {\r\n        if (this.bufferSource) {\r\n            return (Browser.now() - this._startTime) / 1000 + this.startTime;\r\n        }\r\n        return 0;\r\n    }\r\n    get duration() {\r\n        if (this.audioBuffer) {\r\n            return this.audioBuffer.duration;\r\n        }\r\n        return 0;\r\n    }\r\n    _clearBufferSource() {\r\n        if (this.bufferSource) {\r\n            var sourceNode = this.bufferSource;\r\n            if (sourceNode.stop) {\r\n                sourceNode.stop(0);\r\n            }\r\n            else {\r\n                sourceNode.noteOff(0);\r\n            }\r\n            sourceNode.disconnect(0);\r\n            sourceNode.onended = null;\r\n            if (!WebAudioSoundChannel._tryCleanFailed)\r\n                this._tryClearBuffer(sourceNode);\r\n            this.bufferSource = null;\r\n        }\r\n    }\r\n    _tryClearBuffer(sourceNode) {\r\n        if (!Browser.onMac) {\r\n            try {\r\n                sourceNode.buffer = null;\r\n            }\r\n            catch (e) {\r\n                WebAudioSoundChannel._tryCleanFailed = true;\r\n            }\r\n            return;\r\n        }\r\n        try {\r\n            sourceNode.buffer = ILaya.WebAudioSound._miniBuffer;\r\n        }\r\n        catch (e) {\r\n            WebAudioSoundChannel._tryCleanFailed = true;\r\n        }\r\n    }\r\n    stop() {\r\n        super.stop();\r\n        this._clearBufferSource();\r\n        this.audioBuffer = null;\r\n        if (this.gain)\r\n            this.gain.disconnect();\r\n        this.isStopped = true;\r\n        ILaya.SoundManager.removeChannel(this);\r\n        this.completeHandler = null;\r\n        if (ILaya.SoundManager.autoReleaseSound)\r\n            ILaya.SoundManager.disposeSoundLater(this.url);\r\n    }\r\n    pause() {\r\n        if (!this.isStopped) {\r\n            this._pauseTime = this.position;\r\n        }\r\n        this._clearBufferSource();\r\n        if (this.gain)\r\n            this.gain.disconnect();\r\n        this.isStopped = true;\r\n        ILaya.SoundManager.removeChannel(this);\r\n        if (ILaya.SoundManager.autoReleaseSound)\r\n            ILaya.SoundManager.disposeSoundLater(this.url);\r\n    }\r\n    resume() {\r\n        this.startTime = this._pauseTime;\r\n        this.play();\r\n    }\r\n    set volume(v) {\r\n        this._volume = v;\r\n        if (this.isStopped) {\r\n            return;\r\n        }\r\n        if (this.gain.gain.setTargetAtTime) {\r\n            this.gain.gain.setTargetAtTime(v, this.context.currentTime, WebAudioSoundChannel.SetTargetDelay);\r\n        }\r\n        else\r\n            this.gain.gain.value = v;\r\n    }\r\n    get volume() {\r\n        return this._volume;\r\n    }\r\n}\r\nWebAudioSoundChannel._tryCleanFailed = false;\r\nWebAudioSoundChannel.SetTargetDelay = 0.001;\r\n//# sourceMappingURL=WebAudioSoundChannel.js.map",
  "references": [
    "D:/widgets/LayaDataStructuresAlgorithms/libs/laya/events/Event.ts",
    "D:/widgets/LayaDataStructuresAlgorithms/libs/laya/media/SoundChannel.ts",
    "D:/widgets/LayaDataStructuresAlgorithms/libs/laya/utils/Browser.ts",
    "D:/widgets/LayaDataStructuresAlgorithms/libs/laya/utils/Utils.ts",
    "D:/widgets/LayaDataStructuresAlgorithms/libs/ILaya.ts"
  ],
  "map": "{\"version\":3,\"file\":\"WebAudioSoundChannel.js\",\"sourceRoot\":\"\",\"sources\":[\"../../../../../libs/laya/media/webaudio/WebAudioSoundChannel.ts\"],\"names\":[],\"mappings\":\"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\"}",
  "dts": {
    "name": "D:/widgets/LayaDataStructuresAlgorithms/.rpt2_cache/placeholder/laya/media/webaudio/WebAudioSoundChannel.d.ts",
    "writeByteOrderMark": false,
    "text": "import { SoundChannel } from \"../SoundChannel\";\r\nexport declare class WebAudioSoundChannel extends SoundChannel {\r\n    audioBuffer: any;\r\n    private gain;\r\n    private bufferSource;\r\n    private _currentTime;\r\n    private _volume;\r\n    private _startTime;\r\n    private _pauseTime;\r\n    private context;\r\n    private _onPlayEnd;\r\n    private static _tryCleanFailed;\r\n    static SetTargetDelay: number;\r\n    constructor();\r\n    play(): void;\r\n    private __onPlayEnd;\r\n    readonly position: number;\r\n    readonly duration: number;\r\n    private _clearBufferSource;\r\n    private _tryClearBuffer;\r\n    stop(): void;\r\n    pause(): void;\r\n    resume(): void;\r\n    volume: number;\r\n}\r\n"
  }
}
